---
title: UATAQ CH4
---
<!-- Ben Fasoli -->

```{r, include = F}
tracer <- 'Methane (CH4)'
```

<div class="map">

```{r, echo = F, message = F, warning = F}
library(dplyr)
library(leaflet)

# Display parameters -----------------------------------------------------------
other_sites <- data_frame(site=c('haw', 'wnd'),
                          lat=c(40.734361, 39.9018),
                          lon=c(-111.872139, -113.7181))

pretty_site_names <- data_frame(csp='Castle Peak',
                                dbk='Daybreak',
                                fru='Fruitland',
                                hdp='Hidden Peak',
                                heb='Heber',
                                hpl='Horsepool',
                                imc='Intermountain Medical Center',
                                lgn='Logan',
                                roo='Roosevelt',
                                rpk='Rose Park',
                                sug='Sugarhouse',
                                sun='Suncrest', 
                                trx01='TRAX 1',
                                trx02='TRAX 2',
                                wbb='University of Utah',
                                
                                haw='Hawthorne (DAQ)',
                                wnd='Wendover')
url_link <- data_frame(csp='http://air.utah.edu/s/view/gasview/?site=',
                       dbk=csp,
                       fru=csp,
                       hdp=csp,
                       heb=csp,
                       hpl=csp,
                       imc=csp,
                       lgn=csp,
                       roo=csp,
                       rpk=csp,
                       sug=csp,
                       sun=csp,
                       trx01='http://air.utah.edu/s/view/trax/',
                       trx02=trx01,
                       wbb=csp)
min_max <- data_frame('Carbon Dioxide (CO2)'=c(400, 550),
                      'Methane (CH4)'=c(1.9, 2.5),
                      'Particulate Matter (PM2.5)'=c(0, 55),
                      'Ozone (O3)'=c(10, 90),
                      'Water vapor (H2O)'=c(8000,20000))
short_species <- data_frame('Carbon Dioxide (CO2)'='CO2d_ppm',
                            'Methane (CH4)'='CH4d_ppm',
                            'Particulate Matter (PM2.5)'='PM25_ugm3',
                            'Ozone (O3)'='O3_ppbv')
units <- data_frame('Carbon Dioxide (CO2)'='ppm',
                    'Methane (CH4)'='ppm',
                    'Particulate Matter (PM2.5)'='ug/m^3',
                    'Ozone (O3)'='ppb',
                    'Water vapor (H2O)'='ppm')


# Data read --------------------------------------------------------------------
raw <- readRDS('data/airmap.rds')
dat <- raw$fixed
dat[dat$Time_UTC < Sys.time() - 3800 * 1.5, short_species[[tracer]]] <- NA

last_upd <- max(dat$Time_UTC, na.rm = T) %>%
  strftime('%Y-%m-%d %H:%M %Z')

# Generate popups --------------------------------------------------------------
pup.times <- strftime(as.POSIXct(dat$Time_UTC, origin='1970-01-01'), 
                      '%Y-%m-%d %H:%M %Z')
pop <- character()
for (i in 1:nrow(dat)) {
  conc <-  round(as.numeric(dat[i, short_species[[tracer]]]), 2)
  lastupd <- pup.times[i]
  
  if (is.na(conc)) conc <- 'Unknown'
  if (is.na(lastupd)) lastupd <- 'Unknown'
  
  pop[i] <- paste(sep='<br>',
                  paste0('<b>', pretty_site_names[[dat$site[i]]], '</b>'),
                  paste(tracer, ':<b>', conc, '</b>', units[[tracer]]),
                  paste('Last updated:  ', lastupd),
                  a(target='_blank', 
                    href=paste0(url_link[[dat$site[i]]], dat$site[i]),
                    tags$button(type='button',
                                class='btn btn-danger btn-block',
                                HTML('<i class="fa fa-line-chart"></i>Go to the data!'))))
}


# Color parsing ----------------------------------------------------------------
color <- dat[[short_species[[tracer]]]]
color[color < min_max[[tracer]][1]] <- min_max[[tracer]][1]
color[color > min_max[[tracer]][2]] <- min_max[[tracer]][2]

cpal <- colorNumeric(c('blue', 'cyan', 'green', 'yellow', 'orange', 'red'),
                     seq(min_max[[tracer]][1], 
                         min_max[[tracer]][2], 
                         length.out=64))
cpal_lgnd <- colorNumeric(rev(c('blue', 'cyan', 'green', 'yellow', 'orange', 'red')),
                          -seq(min_max[[tracer]][1], min_max[[tracer]][2], length.out=64))
breaks_lgnd <- rev(-seq(min_max[[tracer]][1], min_max[[tracer]][2], length.out=10))

# Output map -------------------------------------------------------------------
pad <- 0.2

leaf <- leaflet(width = '100%', height = '100%') %>% 
  addTiles('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png',
           attribution = 'UATAQ, Ben Fasoli. Map tiles from CartoDB and Esri') %>%
  addTiles('http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',
           options = tileOptions(opacity = 0.2)) %>%
  fitBounds(min(dat$lon)-pad, min(dat$lat)-pad,
            max(dat$lon)+pad, max(dat$lat)+pad) %>%
  addCircleMarkers(lng=dat$lon, lat=dat$lat, popup=pop, radius=10, weight=2,
                   fillColor=cpal(color), color=cpal(color), 
                   opacity=0.5, fillOpacity=0.5) %>%
  addLegend('bottomright', pal=cpal_lgnd, values=breaks_lgnd, 
            title=paste0('(', units[[tracer]], ')'),
            labFormat=labelFormat(transform=function(x){-x}), opacity=0.7)

# Add TRAX data ----------------------------------------------------------------
dat <- raw$mobile
dat <- dat[ , c('Time_UTC', 'lat', 'lon', 'site', short_species[[tracer]])]
try(dat[dat$Time_UTC < Sys.time() - 3800 * 1.5, short_species[[tracer]]] <- NA)
dat <- na.omit(dat)
if (nrow(dat) > 1) {
  for (site in unique(dat$site)){
    mask <- dat$site == site
    if(nrow(dat[mask, ]) > 300){
      temp <- dat[mask, ]
      smoothby <- 30
      temp[ ,short_species[[tracer]]] <- uataq::run_smooth(temp[ ,short_species[[tracer]]], n=smoothby)
      temp <- temp[trunc(seq(1, nrow(temp), by=smoothby)), ]
    } else temp <- dat[mask, ]
    
    mdat <- na.omit(temp)
    color <- mdat[[short_species[[tracer]]]]
    color[color < min_max[[tracer]][1]] <- min_max[[tracer]][1]
    color[color > min_max[[tracer]][2]] <- min_max[[tracer]][2]
    
    mpop<- paste(sep='<br>',
                 paste0('<b>', pretty_site_names[mdat$site], '</b>'),
                 paste(tracer, ':<b>', round(mdat[[short_species[[tracer]]]], 2), '</b>', units[[tracer]]),
                 paste('Last updated:  ', format(mdat$Time_UTC, '%Y-%m-%d %H:%M %Z')),
                 a(target='_blank',
                   href=url_link[[site]],
                   tags$button(type='button',
                               class='btn action-button btn-large btn-danger',
                               HTML('<i class="fa fa-line-chart"></i>Go to the data!'))))
    malpha <- scales::rescale(as.numeric(mdat$Time_UTC), to = c(0.1, 0.7))
    
    leaf <- leaf %>%
      addCircleMarkers(lng=mdat$lon, lat=mdat$lat, radius=3, popup=mpop, stroke=T, weight=2,
                       fillColor=cpal(color), color=cpal(color),
                       opacity=malpha, fillOpacity=malpha) %>%
      addCircleMarkers(lng=tail(mdat$lon, 1), lat=tail(mdat$lat, 1), radius=5, popup=tail(mpop, 1),
                       stroke=T, weight=1, fillColor=cpal(tail(color, 1)), color='black',
                       opacity=0.8, fillOpacity=0.8)
  }
}
leaf
```
</div>

<div class="mobileHide" style="position:fixed; top: 55px; right: 5px; text-align: left;">
Last updated: `r last_upd`
</div>

<div class="mobileHide" style="position:fixed; left: 5px; bottom: 5px; text-align: center;">
<a href="http://lair.utah.edu">
<img src="http://air.utah.edu/~benfasoli/img/LAIR_logo.png" style="width: 300px;">
</a>
<a href="http://sustainability.utah.edu">
<img src="http://air.utah.edu/~benfasoli/img/SCIF_logo.png" style="width: 150px;">
</a>
</div>
